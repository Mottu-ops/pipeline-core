name: Database Migration

on:
  workflow_call:

permissions:
  contents: read


jobs:
  build:
    name: build migration
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v3
    
    - run: printenv | sort
    - run: source .github\workflows\.environments
    - run: printenv | sort

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v1.0.2

    - name: Restore NuGet packages
      working-directory: ${{env.GITHUB_WORKSPACE}}
      run: nuget restore ${{env.SOLUTION_FILE_PATH}}

    - name: Build
      working-directory: ${{env.GITHUB_WORKSPACE}}
      run: msbuild /m /p:Configuration=${{env.BUILD_CONFIGURATION}} ${{env.SOLUTION_FILE_PATH}} 


    - run: mkdir -p build-artifacts

    - run: mv mottu.Script\bin\Release\* build-artifacts

    - name: Upload Artifact GitHub Action
      uses: actions/upload-artifact@v2
      with: 
        name: build
        path: build-artifacts

  apply-development:
    name: apply development
    environment: development
    runs-on: windows-latest
    needs: build
    steps:
      - name: Download a Build Artifact
        uses: actions/download-artifact@v3.0.0
        with:
          name: build
          path: .
      
      - run: dir

      # - name: Azure SQL Deploy (dacpac, file, folder)
      #   # You may pin to the exact commit or the version.
      #   # uses: XLipcak/sql-action@1b2b1ea66beb232831e97be2be8382be8f006840
      #   uses: XLipcak/sql-action@v1.0.5
      #   with:
      #     # Name of the Azure SQL Server name, like Fabrikam.database.windows.net.
      #     server-name: 
      #     # The connection string, including authentication information, for the Azure SQL Server database.
      #     connection-string: 
      #     # Path to DACPAC file. *.dacpac or a folder to deploy
      #     dacpac-package: # optional
      #     # Path to SQL script file. *.sql or a folder to deploy
      #     sql-file: # optional
      #     # Path to SQL folder to deploy
      #     sql-folder: # optional
      #     # In case DACPAC option is selected, additional SqlPackage.exe arguments that will be applied. When SQL query option is selected, additional sqlcmd.exe arguments will be applied.
      #     arguments: # optional        



  apply-production:
    name: apply production
    environment: production
    runs-on: windows-latest
    needs: build
    steps:
      - name: Download a Build Artifact
        uses: actions/download-artifact@v3.0.0
        with:
          name: build
          path: .
      
      - run: dir

      # - name: Azure SQL Deploy (dacpac, file, folder)
      #   # You may pin to the exact commit or the version.
      #   # uses: XLipcak/sql-action@1b2b1ea66beb232831e97be2be8382be8f006840
      #   uses: XLipcak/sql-action@v1.0.5
      #   with:
      #     # Name of the Azure SQL Server name, like Fabrikam.database.windows.net.
      #     server-name: 
      #     # The connection string, including authentication information, for the Azure SQL Server database.
      #     connection-string: 
      #     # Path to DACPAC file. *.dacpac or a folder to deploy
      #     dacpac-package: # optional
      #     # Path to SQL script file. *.sql or a folder to deploy
      #     sql-file: # optional
      #     # Path to SQL folder to deploy
      #     sql-folder: # optional
      #     # In case DACPAC option is selected, additional SqlPackage.exe arguments that will be applied. When SQL query option is selected, additional sqlcmd.exe arguments will be applied.
      #     arguments: # optional        
